<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>III. 配置服务端 | &quot;org.minbox.framework&quot;</title>
    <meta name="description" content="致力于向广大开发者提供一系列 “开箱即用” 的框架落地实现解决方案。">
    
    
    <link rel="preload" href="/assets/css/0.styles.a4a6d600.css" as="style"><link rel="preload" href="/assets/js/app.3abc0832.js" as="script"><link rel="preload" href="/assets/js/2.7b9f2484.js" as="script"><link rel="preload" href="/assets/js/8.888bfaf6.js" as="script"><link rel="prefetch" href="/assets/js/10.2d422ad8.js"><link rel="prefetch" href="/assets/js/3.52b17f97.js"><link rel="prefetch" href="/assets/js/4.8c4bfc35.js"><link rel="prefetch" href="/assets/js/5.e8598797.js"><link rel="prefetch" href="/assets/js/6.4cbf83d6.js"><link rel="prefetch" href="/assets/js/7.87f564f6.js"><link rel="prefetch" href="/assets/js/9.e3938554.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a4a6d600.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">&quot;org.minbox.framework&quot;</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="组件" class="dropdown-title"><span class="title">组件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>日志组件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/logging/" class="nav-link router-link-active">分布式链路日志</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://blog.yuqiyu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  作者博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="最佳实践" class="dropdown-title"><span class="title">最佳实践</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://blog.yuqiyu.com/apiboot-all-articles.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  系列文章
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/minbox-projects/api-boot-chapter" target="_blank" rel="noopener noreferrer" class="nav-link external">
  文章源码
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="源码" class="dropdown-title"><span class="title">源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/minbox-projects" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/minbox-projects" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="组件" class="dropdown-title"><span class="title">组件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>日志组件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/logging/" class="nav-link router-link-active">分布式链路日志</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://blog.yuqiyu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  作者博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="最佳实践" class="dropdown-title"><span class="title">最佳实践</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://blog.yuqiyu.com/apiboot-all-articles.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  系列文章
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/minbox-projects/api-boot-chapter" target="_blank" rel="noopener noreferrer" class="nav-link external">
  文章源码
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="源码" class="dropdown-title"><span class="title">源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/minbox-projects" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/minbox-projects" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/logging/concept.html" class="sidebar-link">I. 概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/concept.html#_1-链路架构图" class="sidebar-link">1. 链路架构图</a></li><li class="sidebar-sub-header"><a href="/logging/concept.html#_2-提交使用中遇到的问题" class="sidebar-link">2. 提交使用中遇到的问题</a></li><li class="sidebar-sub-header"><a href="/logging/concept.html#_3-apiboot集成实践示例" class="sidebar-link">3. ApiBoot集成实践示例</a></li></ul></li><li><a href="/logging/config-client.html" class="sidebar-link">II. 配置客户端</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-client.html#_4-启用客户端" class="sidebar-link">4. 启用客户端</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_5-透传链路信息" class="sidebar-link">5. 透传链路信息</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-client.html#_5-1-resttemplate透传链路信息" class="sidebar-link">5.1. RestTemplate透传链路信息</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_5-2-openfeign透传链路信息" class="sidebar-link">5.2. OpenFeign透传链路信息</a></li></ul></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_6-发现admin并上报日志" class="sidebar-link">6. 发现Admin并上报日志</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-client.html#_6-1-指定地址发现admin" class="sidebar-link">6.1. 指定地址发现Admin</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_6-2-服务注册中心发现admin" class="sidebar-link">6.2. 服务注册中心发现Admin</a></li></ul></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_7-延迟上报日志" class="sidebar-link">7. 延迟上报日志</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-client.html#_7-1-配置上报方式" class="sidebar-link">7.1. 配置上报方式</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_7-2-设置单次上报的日志数量" class="sidebar-link">7.2. 设置单次上报的日志数量</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_7-3-设置上报日志间隔时间" class="sidebar-link">7.3. 设置上报日志间隔时间</a></li></ul></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_8-自定义traceid生成规则" class="sidebar-link">8. 自定义TraceID生成规则</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_9-自定义spanid生成规则" class="sidebar-link">9. 自定义SpanID生成规则</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_10-排除部分路径不进行上报日志" class="sidebar-link">10. 排除部分路径不进行上报日志</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_11-安全上报日志" class="sidebar-link">11. 安全上报日志</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-client.html#_11-1-指定admin地址方式配置" class="sidebar-link">11.1. 指定Admin地址方式配置</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_11-2-服务注册中心配置" class="sidebar-link">11.2. 服务注册中心配置</a></li></ul></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_12-控制台显示上报日志" class="sidebar-link">12. 控制台显示上报日志</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_13-格式化控制台显示上报日志" class="sidebar-link">13. 格式化控制台显示上报日志</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_14-自定义日志上报通知" class="sidebar-link">14. 自定义日志上报通知</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-client.html#_14-1-内置的日志通知" class="sidebar-link">14.1. 内置的日志通知</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_14-2-自定义多个日志上报通知" class="sidebar-link">14.2. 自定义多个日志上报通知</a></li></ul></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_15-全局日志" class="sidebar-link">15. 全局日志</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-client.html#_15-1-日志占位符" class="sidebar-link">15.1 日志占位符</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_15-2-内存方式存储" class="sidebar-link">15.2 内存方式存储</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_15-3-采集异常堆栈信息" class="sidebar-link">15.3 采集异常堆栈信息</a></li></ul></li></ul></li><li><a href="/logging/config-admin.html" class="active sidebar-link">III. 配置服务端</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_16-启用服务端" class="sidebar-link">16. 启用服务端</a></li><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_17-初始化数据库" class="sidebar-link">17. 初始化数据库</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_17-1-将日志持久化到数据库" class="sidebar-link">17.1. 将日志持久化到数据库</a></li></ul></li><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_18-将admin注册到springcloud" class="sidebar-link">18. 将Admin注册到SpringCloud</a></li><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_19-启用安全配置" class="sidebar-link">19. 启用安全配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_19-1-添加支持spring-security" class="sidebar-link">19.1. 添加支持Spring Security</a></li><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_19-2-配置安全用户" class="sidebar-link">19.2. 配置安全用户</a></li></ul></li><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_20-监听日志上报事件" class="sidebar-link">20. 监听日志上报事件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_20-1-多监听事件实现" class="sidebar-link">20.1. 多监听事件实现</a></li></ul></li><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_21-loggingadminfactorybean" class="sidebar-link">21. LoggingAdminFactoryBean</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_21-1-设置数据源" class="sidebar-link">21.1. 设置数据源</a></li><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_21-2-控制台输出上报的日志" class="sidebar-link">21.2. 控制台输出上报的日志</a></li><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_21-3-格式化控制台输出日志" class="sidebar-link">21.3. 格式化控制台输出日志</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="iii-配置服务端"><a href="#iii-配置服务端" class="header-anchor">#</a> III. 配置服务端</h1> <h2 id="_16-启用服务端"><a href="#_16-启用服务端" class="header-anchor">#</a> 16. 启用服务端</h2> <p>在<code>minbox-logging-spring-context</code>依赖内提供了<code>@EnableLoggingAdmin</code>注解来启用服务端，配置使用该注解后通过<code>@Import</code>自动注册<code>Logging Admin</code>运行时所需要的<code>Bean</code>。</p> <p><strong>@EnableLoggingAdmin</strong>使用示例如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableLoggingAdmin</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApiBootLoggingAdminApplication</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * logger instance
     */</span>
    <span class="token keyword">static</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">ApiBootLoggingAdminApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ApiBootLoggingAdminApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}服务启动成功.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Logging Admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="_17-初始化数据库"><a href="#_17-初始化数据库" class="header-anchor">#</a> 17. 初始化数据库</h2> <p><code>Logging Admin</code>支持将<code>Logging Client</code>上报的请求日志保存到数据库，而且提供了固定的表结构，如下所示：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SET</span> NAMES utf8mb4 <span class="token punctuation">;</span>
<span class="token comment">--</span>
<span class="token comment">-- Table structure for table `logging_service_details`</span>
<span class="token comment">--</span>

<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>logging_service_details<span class="token punctuation">`</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> character_set_client <span class="token operator">=</span> utf8mb4 <span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>logging_service_details<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>lsd_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lsd_service_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'上报服务的ID，对应spring.application.name配置值'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lsd_service_ip<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'上报服务的IP地址'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lsd_service_port<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'上报服务的端口号'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lsd_last_report_time<span class="token punctuation">`</span> <span class="token keyword">timestamp</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'最后一次上报时间，每次上报更新'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lsd_create_time<span class="token punctuation">`</span> <span class="token keyword">timestamp</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'首次上报时创建时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>lsd_id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_general_ci <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'上报日志的客户端服务详情'</span><span class="token punctuation">;</span>

<span class="token comment">--</span>
<span class="token comment">-- Table structure for table `logging_request_logs`</span>
<span class="token comment">--</span>

<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>logging_request_logs<span class="token punctuation">`</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> character_set_client <span class="token operator">=</span> utf8mb4 <span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>logging_request_logs<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>lrl_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'主键，UUID'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lrl_service_detail_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'服务详情编号，关联logging_service_details主键'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lrl_trace_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'链路ID'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lrl_parent_span_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'上级跨度ID'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lrl_span_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'跨度ID'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lrl_start_time<span class="token punctuation">`</span> <span class="token keyword">mediumtext</span> <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">COMMENT</span> <span class="token string">'请求开始时间'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lrl_end_time<span class="token punctuation">`</span> <span class="token keyword">mediumtext</span> <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">COMMENT</span> <span class="token string">'请求结束时间'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lrl_http_status<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'请求响应状态码'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lrl_request_body<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">COMMENT</span> <span class="token string">'请求主体内容'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lrl_request_headers<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">COMMENT</span> <span class="token string">'请求头信息'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lrl_request_ip<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'发起请求客户端的IP地址'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lrl_request_method<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'请求方式'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lrl_request_uri<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'请求路径'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lrl_response_body<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">COMMENT</span> <span class="token string">'响应内容'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lrl_response_headers<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token keyword">COMMENT</span> <span class="token string">'响应头信息'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lrl_time_consuming<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'请求耗时'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lrl_create_time<span class="token punctuation">`</span> <span class="token keyword">timestamp</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'日志保存时间'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lrl_request_params<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COLLATE</span> utf8mb4_general_ci<span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lrl_exception_stack<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COLLATE</span> utf8mb4_general_ci<span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>lrl_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>logging_request_logs_LRL_SERVICE_DETAIL_ID_index<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>lrl_service_detail_id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_general_ci <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'请求日志信息表'</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h3 id="_17-1-将日志持久化到数据库"><a href="#_17-1-将日志持久化到数据库" class="header-anchor">#</a> 17.1. 将日志持久化到数据库</h3> <p>初始化<code>Logging Admin</code>所需要的表结构之后，我们在集成<code>Logging Admin</code>的项目中添加<code>数据源</code>、<code>数据库驱动</code>、<code>持久化框架</code>等依赖，然后进行配置数据源相关数据库参数，下面以<strong>SpringBoot</strong>项目示例。</p> <h4 id="_17-1-1-添加所需依赖"><a href="#_17-1-1-添加所需依赖" class="header-anchor">#</a> 17.1.1 添加所需依赖</h4> <p><code>pom.xml</code>新增依赖如下所示：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--ApiBoot提供的持久化框架--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.minbox.framework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>api-boot-starter-mybatis-enhance<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>{ApiBoot最新版本}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--MySQL数据库驱动--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>8.0.17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--Hikari数据源--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.zaxxer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>HikariCP<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><code>Logging Admin</code>并不固定依赖<code>ApiBoot</code>提供的持久化框架，可以使用任意框架依赖，<code>Logging Admin</code>内部只是需要<code>DataSource</code>的实例，也可以自定义创建<code>DataSource</code>对象放入<code>Spring IOC</code>。</p> <h4 id="_17-1-2-配置数据源参数"><a href="#_17-1-2-配置数据源参数" class="header-anchor">#</a> 17.1.2. 配置数据源参数</h4> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token comment"># 数据源参数</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">type</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/test
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="_18-将admin注册到springcloud"><a href="#_18-将admin注册到springcloud" class="header-anchor">#</a> 18. 将Admin注册到SpringCloud</h2> <p><code>Logging Admin</code>作为一个依赖添加到<code>SpringBoot</code>项目内，我们只需要考虑如何将<code>SpringBoot</code>项目注册到<code>服务注册中心</code>（SpringCloud Service Register Center），如果你使用的<code>Eureka</code>作为服务注册中心，请访问我之前编写的文章查看<a href="http://blog.yuqiyu.com/spring-cloud-eureka-provider.html" target="_blank">将微服务提供者注册到Eureka服务中心</a>。</p> <h2 id="_19-启用安全配置"><a href="#_19-启用安全配置" class="header-anchor">#</a> 19. 启用安全配置</h2> <p><code>Logging Admin</code>的安全采用的是<code>Spring Security</code>提供的<code>Basic Auth</code>来完成。</p> <h3 id="_19-1-添加支持spring-security"><a href="#_19-1-添加支持spring-security" class="header-anchor">#</a> 19.1. 添加支持Spring Security</h3> <p>在项目的<code>pom.xml</code>内添加如下依赖：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_19-2-配置安全用户"><a href="#_19-2-配置安全用户" class="header-anchor">#</a> 19.2. 配置安全用户</h3> <p>建议采用<code>Spring Security</code>提供的<code>内存方式</code>来配置<code>Logging Admin</code>，<code>application.yml</code>配置文件如下所示：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span>
      <span class="token comment"># 用户名</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> user
      <span class="token comment"># 密码</span>
      <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="_20-监听日志上报事件"><a href="#_20-监听日志上报事件" class="header-anchor">#</a> 20. 监听日志上报事件</h2> <p><code>Logging Admin</code>支持自定义处理监听到<code>Logging Client</code>上报的日志信息，可进行自定义的存储，格式化处理，分组归类等，自定义事件监听沿用了<code>Spring Event/Listener</code>方式，如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 自定义上报日志事件{@link ReportLogEvent}监听
 *
 * @author 恒宇少年
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerReportEventListener</span> <span class="token keyword">implements</span> <span class="token class-name">SmartApplicationListener</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 判断事件类型为{@link ReportLogEvent}
     *
     * @param eventType
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supportsEventType</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ApplicationEvent</span><span class="token punctuation">&gt;</span></span> eventType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ReportLogEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> eventType<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 自定义处理业务
     *
     * @param event
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ReportLogEvent</span> reportLogEvent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ReportLogEvent</span><span class="token punctuation">)</span> event<span class="token punctuation">;</span>
        <span class="token class-name">LoggingClientNotice</span> loggingClientNotice <span class="token operator">=</span> reportLogEvent<span class="token punctuation">.</span><span class="token function">getLogClientNotice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;上报日志的服务Id：&quot;</span> <span class="token operator">+</span> loggingClientNotice<span class="token punctuation">.</span><span class="token function">getClientServiceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 自定义业务处理...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="_20-1-多监听事件实现"><a href="#_20-1-多监听事件实现" class="header-anchor">#</a> 20.1. 多监听事件实现</h3> <p><code>Logging Admin</code>由于采用的是<code>Spring</code>内部提供的<code>SmartApplicationListener</code>方式来监听<code>ReportLogEvent</code>事件，所以只需要添加多个自定义监听实现<code>SmartApplicationListener</code>接口即可。</p> <p><code>SmartApplicationListener</code>由于实现了<code>Ordered</code>接口，所以提供优先级配置方法<code>getOrder</code>，与<code>LoggingNotice</code>接口优先级策略一致，<strong>值越小优先级越高</strong>。</p> <p>详细了解<code>Spring</code>提供的<code>Event/Listener</code>可以访问<a href="http://blog.yuqiyu.com/spring-boot-chapter27.html" target="_blank">SpringBoot使用ApplicationEvent&amp;Listener完成业务解耦</a>。</p> <h2 id="_21-loggingadminfactorybean"><a href="#_21-loggingadminfactorybean" class="header-anchor">#</a> 21. LoggingAdminFactoryBean</h2> <p><code>LoggingAdminFactoryBean</code>是配置<code>Logging Admin</code>的必要途径，通过该类可以对<code>Logging Admin</code>进行全方面的配置。</p> <p><code>ApiBoot</code>集成<code>Logging Admin FactoryBean</code>示例如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
* instantiation {@link LoggingAdminFactoryBean}
*
* @param dataSource {@link DataSource}
* @return LoggingAdminFactoryBean
*/</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">LoggingAdminFactoryBean</span> <span class="token function">loggingAdminFactoryBean</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">LoggingAdminFactoryBean</span> factoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoggingAdminFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  factoryBean<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  factoryBean<span class="token punctuation">.</span><span class="token function">setShowConsoleReportLog</span><span class="token punctuation">(</span>apiBootLoggingAdminProperties<span class="token punctuation">.</span><span class="token function">isShowConsoleReportLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  factoryBean<span class="token punctuation">.</span><span class="token function">setFormatConsoleLogJson</span><span class="token punctuation">(</span>apiBootLoggingAdminProperties<span class="token punctuation">.</span><span class="token function">isFormatConsoleLogJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;【LoggingAdminFactoryBean】init successfully.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> factoryBean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><code>ApiBoot</code> 集成<code>LoggingAdminFactoryBean</code>详细源码请访问<a href="https://gitee.com/minbox-projects/api-boot/blob/master/api-boot-project/api-boot-autoconfigure/src/main/java/org/minbox/framework/api/boot/autoconfigure/logging/admin/ApiBootLoggingAdminAutoConfiguration.java" target="_blank">ApiBootLoggingAdminAutoConfiguration</a>。</p> <h3 id="_21-1-设置数据源"><a href="#_21-1-设置数据源" class="header-anchor">#</a> 21.1. 设置数据源</h3> <p>通过<code>LoggingAdminFactoryBean#setDataSource</code>方法来设置<code>Logging Admin</code>所需要操作日志数据的数据源，如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 设置数据源 </span>
factoryBean<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_21-2-控制台输出上报的日志"><a href="#_21-2-控制台输出上报的日志" class="header-anchor">#</a> 21.2. 控制台输出上报的日志</h3> <p>通过<code>LoggingAdminFactoryBean#setShowConsoleReportLog</code>方法来控制是否在控制台打印<code>Logging Client</code>上报的日志信息，如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 设置在控制台输出Logging Client 上报的日志</span>
factoryBean<span class="token punctuation">.</span><span class="token function">setShowConsoleReportLog</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_21-3-格式化控制台输出日志"><a href="#_21-3-格式化控制台输出日志" class="header-anchor">#</a> 21.3. 格式化控制台输出日志</h3> <p>通过<code>LoggingAdminFactoryBean#setFormatConsoleLogJson</code>方法来格式化控制台输出的日志，如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 格式化控制台输出的日志</span>
factoryBean<span class="token punctuation">.</span><span class="token function">setFormatConsoleLogJson</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">12/22/2019, 12:33:52 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/logging/config-client.html" class="prev">II. 配置客户端</a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3abc0832.js" defer></script><script src="/assets/js/2.7b9f2484.js" defer></script><script src="/assets/js/8.888bfaf6.js" defer></script>
  </body>
</html>
