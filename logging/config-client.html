<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>II. 配置客户端 | &quot;org.minbox.framework&quot;</title>
    <meta name="description" content="致力于向广大开发者提供一系列 “开箱即用” 的框架落地实现解决方案。">
    
    
    <link rel="preload" href="/assets/css/0.styles.a4a6d600.css" as="style"><link rel="preload" href="/assets/js/app.3abc0832.js" as="script"><link rel="preload" href="/assets/js/2.7b9f2484.js" as="script"><link rel="preload" href="/assets/js/9.e3938554.js" as="script"><link rel="prefetch" href="/assets/js/10.2d422ad8.js"><link rel="prefetch" href="/assets/js/3.52b17f97.js"><link rel="prefetch" href="/assets/js/4.8c4bfc35.js"><link rel="prefetch" href="/assets/js/5.e8598797.js"><link rel="prefetch" href="/assets/js/6.4cbf83d6.js"><link rel="prefetch" href="/assets/js/7.87f564f6.js"><link rel="prefetch" href="/assets/js/8.888bfaf6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a4a6d600.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">&quot;org.minbox.framework&quot;</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="组件" class="dropdown-title"><span class="title">组件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>日志组件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/logging/" class="nav-link router-link-active">分布式链路日志</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://blog.yuqiyu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  作者博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="最佳实践" class="dropdown-title"><span class="title">最佳实践</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://blog.yuqiyu.com/apiboot-all-articles.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  系列文章
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/minbox-projects/api-boot-chapter" target="_blank" rel="noopener noreferrer" class="nav-link external">
  文章源码
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="源码" class="dropdown-title"><span class="title">源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/minbox-projects" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/minbox-projects" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="组件" class="dropdown-title"><span class="title">组件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>日志组件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/logging/" class="nav-link router-link-active">分布式链路日志</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://blog.yuqiyu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  作者博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="最佳实践" class="dropdown-title"><span class="title">最佳实践</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://blog.yuqiyu.com/apiboot-all-articles.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  系列文章
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/minbox-projects/api-boot-chapter" target="_blank" rel="noopener noreferrer" class="nav-link external">
  文章源码
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="源码" class="dropdown-title"><span class="title">源码</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/minbox-projects" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/minbox-projects" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/logging/concept.html" class="sidebar-link">I. 概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/concept.html#_1-链路架构图" class="sidebar-link">1. 链路架构图</a></li><li class="sidebar-sub-header"><a href="/logging/concept.html#_2-提交使用中遇到的问题" class="sidebar-link">2. 提交使用中遇到的问题</a></li><li class="sidebar-sub-header"><a href="/logging/concept.html#_3-apiboot集成实践示例" class="sidebar-link">3. ApiBoot集成实践示例</a></li></ul></li><li><a href="/logging/config-client.html" class="active sidebar-link">II. 配置客户端</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-client.html#_4-启用客户端" class="sidebar-link">4. 启用客户端</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_5-透传链路信息" class="sidebar-link">5. 透传链路信息</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-client.html#_5-1-resttemplate透传链路信息" class="sidebar-link">5.1. RestTemplate透传链路信息</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_5-2-openfeign透传链路信息" class="sidebar-link">5.2. OpenFeign透传链路信息</a></li></ul></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_6-发现admin并上报日志" class="sidebar-link">6. 发现Admin并上报日志</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-client.html#_6-1-指定地址发现admin" class="sidebar-link">6.1. 指定地址发现Admin</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_6-2-服务注册中心发现admin" class="sidebar-link">6.2. 服务注册中心发现Admin</a></li></ul></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_7-延迟上报日志" class="sidebar-link">7. 延迟上报日志</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-client.html#_7-1-配置上报方式" class="sidebar-link">7.1. 配置上报方式</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_7-2-设置单次上报的日志数量" class="sidebar-link">7.2. 设置单次上报的日志数量</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_7-3-设置上报日志间隔时间" class="sidebar-link">7.3. 设置上报日志间隔时间</a></li></ul></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_8-自定义traceid生成规则" class="sidebar-link">8. 自定义TraceID生成规则</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_9-自定义spanid生成规则" class="sidebar-link">9. 自定义SpanID生成规则</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_10-排除部分路径不进行上报日志" class="sidebar-link">10. 排除部分路径不进行上报日志</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_11-安全上报日志" class="sidebar-link">11. 安全上报日志</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-client.html#_11-1-指定admin地址方式配置" class="sidebar-link">11.1. 指定Admin地址方式配置</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_11-2-服务注册中心配置" class="sidebar-link">11.2. 服务注册中心配置</a></li></ul></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_12-控制台显示上报日志" class="sidebar-link">12. 控制台显示上报日志</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_13-格式化控制台显示上报日志" class="sidebar-link">13. 格式化控制台显示上报日志</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_14-自定义日志上报通知" class="sidebar-link">14. 自定义日志上报通知</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-client.html#_14-1-内置的日志通知" class="sidebar-link">14.1. 内置的日志通知</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_14-2-自定义多个日志上报通知" class="sidebar-link">14.2. 自定义多个日志上报通知</a></li></ul></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_15-全局日志" class="sidebar-link">15. 全局日志</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-client.html#_15-1-日志占位符" class="sidebar-link">15.1 日志占位符</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_15-2-内存方式存储" class="sidebar-link">15.2 内存方式存储</a></li><li class="sidebar-sub-header"><a href="/logging/config-client.html#_15-3-采集异常堆栈信息" class="sidebar-link">15.3 采集异常堆栈信息</a></li></ul></li></ul></li><li><a href="/logging/config-admin.html" class="sidebar-link">III. 配置服务端</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_16-启用服务端" class="sidebar-link">16. 启用服务端</a></li><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_17-初始化数据库" class="sidebar-link">17. 初始化数据库</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_17-1-将日志持久化到数据库" class="sidebar-link">17.1. 将日志持久化到数据库</a></li></ul></li><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_18-将admin注册到springcloud" class="sidebar-link">18. 将Admin注册到SpringCloud</a></li><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_19-启用安全配置" class="sidebar-link">19. 启用安全配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_19-1-添加支持spring-security" class="sidebar-link">19.1. 添加支持Spring Security</a></li><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_19-2-配置安全用户" class="sidebar-link">19.2. 配置安全用户</a></li></ul></li><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_20-监听日志上报事件" class="sidebar-link">20. 监听日志上报事件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_20-1-多监听事件实现" class="sidebar-link">20.1. 多监听事件实现</a></li></ul></li><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_21-loggingadminfactorybean" class="sidebar-link">21. LoggingAdminFactoryBean</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_21-1-设置数据源" class="sidebar-link">21.1. 设置数据源</a></li><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_21-2-控制台输出上报的日志" class="sidebar-link">21.2. 控制台输出上报的日志</a></li><li class="sidebar-sub-header"><a href="/logging/config-admin.html#_21-3-格式化控制台输出日志" class="sidebar-link">21.3. 格式化控制台输出日志</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ii-配置客户端"><a href="#ii-配置客户端" class="header-anchor">#</a> II. 配置客户端</h1> <h2 id="_4-启用客户端"><a href="#_4-启用客户端" class="header-anchor">#</a> 4. 启用客户端</h2> <p>在<code>minbox-logging-spring-context</code>依赖内提供了<code>@EnableLoggingClient</code>注解来启用客户端，配置使用该注解后通过<code>@Import</code>自动注册<code>Logging Client</code>运行时所需要的<code>Bean</code>。</p> <p><strong>@EnableLoggingClient</strong>使用示例如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableLoggingClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApiBootLoggingApplication</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * logger instance
     */</span>
    <span class="token keyword">static</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">ApiBootLoggingApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ApiBootLoggingApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}服务启动成功.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ApiBoot Logging Client&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="_5-透传链路信息"><a href="#_5-透传链路信息" class="header-anchor">#</a> 5. 透传链路信息</h2> <p>每发送一个请求时就会产生一条链路信息，而链路单元（Span）之前的相互访问目前则以<code>http</code>、<code>rpc</code>等方式作为主要占比。</p> <p>链路信息（Trace）的传递，<code>Logging Client</code>内部提供了提取请求<code>header</code>内的链路信息编号（TraceID）、上级单元编号（Parent SpanID），整条链路都通过这种方式来进行上下级单元关系、链路关系绑定。</p> <h3 id="_5-1-resttemplate透传链路信息"><a href="#_5-1-resttemplate透传链路信息" class="header-anchor">#</a> 5.1. RestTemplate透传链路信息</h3> <p><code>RestTemplate</code>是<code>Spring Web</code>组件提供的请求封装对象，可用于发送指定方式的请求到目标地址，可携带<code>header</code>信息进行传递身份认证信息、请求、响应等信息。</p> <p><code>Logging Client</code>则是利用<code>RestTemplate</code>的拦截器将链路（Trace）信息写入请求的<code>header</code>进行传递到下一个单元（Span）。</p> <div class="custom-block tip"><p class="custom-block-title">小提示</p> <p><code>Logging Client</code>已经提供了<code>RestTemplate</code>拦截器实现类<code>LoggingRestTemplateInterceptor</code>，在<code>LoggingFactoryBean#afterPropertiesSet</code>方法内进行实例化并且已经设置了拦截器，在<code>Logging Client</code>上报请求日志信息时，都是通过<code>LoggingFactoryBean#restTemplate</code>来执行发送请求到<code>Admin</code>，因此只需要实例化<code>LoggingFactoryBean</code>即可。</p></div> <h3 id="_5-2-openfeign透传链路信息"><a href="#_5-2-openfeign透传链路信息" class="header-anchor">#</a> 5.2. OpenFeign透传链路信息</h3> <p><code>OpenFeign</code>是<code>SpringCloud</code>为服务之间方法相互调用的实现方式，根据接口配置信息来发送请求并获取响应内容。</p> <p><code>Logging Client</code>同样是利用<code>OpenFeign</code>提供的拦截器将链路（Trace）信息写入服务相互调用的请求<code>header</code>，进行传递到下一个服务。</p> <div class="custom-block tip"><p class="custom-block-title">小提示</p> <p><code>Logging Client</code>内部提供了<code>RequestInterceptor</code>接口实现类<code>LoggingOpenFeignInterceptor</code>来完成链路信息透传，<code>OpenFeign</code>会自动检索<code>Spring IOC</code>容器内<code>RequestInterceptor</code>接口的实现类实例，每次通过<code>OpenFeign</code>发起请求时会调用<code>RequestInterceptor</code>实现类的<code>apply</code>方法来完成拦截业务处理。</p></div> <h2 id="_6-发现admin并上报日志"><a href="#_6-发现admin并上报日志" class="header-anchor">#</a> 6. 发现Admin并上报日志</h2> <p><code>Logging Client</code>默认本地不进行持久化存储<code>请求日志</code>信息，而是将本地生成的<code>请求日志</code>详细信息上报到<code>Logging Admin</code>，由<code>Admin</code>进行存储、分析等。</p> <p><code>Logging Client</code>内部提供<code>LoggingAdminDiscovery#lookup</code>接口方法来进行<strong>发现Admin地址</strong>。</p> <h3 id="_6-1-指定地址发现admin"><a href="#_6-1-指定地址发现admin" class="header-anchor">#</a> 6.1. 指定地址发现Admin</h3> <p><code>Logging Client</code>获取指定<code>Admin</code>地址是通过<code>LoggingAdminDiscovery</code>其中一个实现类<code>LoggingAppointAdminDiscovery</code>来进行获取。</p> <p>下面是<code>ApiBoot</code>配置使用<strong>LoggingAppointAdminDiscovery</strong>实践示例，</p> <p>详见源码，<strong><a href="https://gitee.com/minbox-projects/api-boot/blob/master/api-boot-project/api-boot-autoconfigure/src/main/java/org/minbox/framework/api/boot/autoconfigure/logging/ApiBootLoggingAdminAppointAutoConfiguration.java" target="_blank">ApiBootLoggingAdminAppointAutoConfiguration</a></strong>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
* ApiBoot Logging Admin Config Discovery
* Multiple Use &quot;,&quot; Separation
*
* @return LoggingAdminDiscovery
*/</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
<span class="token keyword">public</span> <span class="token class-name">LoggingAppointAdminDiscovery</span> <span class="token function">loggingConfigAdminDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> adminAddressArray <span class="token operator">=</span> apiBootLoggingProperties<span class="token punctuation">.</span><span class="token function">getAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServerAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">LoggingAppointAdminDiscovery</span> appointAdminDiscovery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoggingAppointAdminDiscovery</span><span class="token punctuation">(</span>adminAddressArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> appointAdminDiscovery<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><code>LoggingAppointAdminDiscovery</code>构造函数需提供<code>Logging Admin</code>地址数组，格式为：<code>ip（IP地址）:port（端口号）</code>，并不需要添加任何<code>http</code>、<code>https</code>前缀。</p> <h4 id="_6-1-1-多admin地址负载均衡配置"><a href="#_6-1-1-多admin地址负载均衡配置" class="header-anchor">#</a> 6.1.1. 多Admin地址负载均衡配置</h4> <p>如果我们在创建<code>LoggingAppointAdminDiscovery</code>对象时传递了多个<code>Logging Admin</code>地址，比如：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
<span class="token keyword">public</span> <span class="token class-name">LoggingAppointAdminDiscovery</span> <span class="token function">loggingConfigAdminDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 初始化Logging Admin地址列表</span>
  <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> adminAddressArray <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;127.0.0.1:8080,127.0.0.1:9090&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token class-name">LoggingAppointAdminDiscovery</span> appointAdminDiscovery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoggingAppointAdminDiscovery</span><span class="token punctuation">(</span>adminAddressArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> appointAdminDiscovery<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如上所示，我启动了两个<code>Logging Admin</code>来进行接收<code>Logging Client</code>采集到的请求日志信息后执行存储，而<code>Logging Client</code>具体使用什么<code>LoadBlanace</code>（负载均衡）策略来进行选择上报的<code>Logging Admin</code>节点？</p> <p><code>Logging Client</code>提供了<code>LoadBalanceStrategy</code>负载均衡策略接口，而内部提供了两种策略的实现，分别是：<code>RandomWeightedStrategy</code>、<code>SmoothWeightedRoundRobinStrategy</code>。</p> <p><strong>Logging Client默认采用SmoothWeightedRoundRobinStrategy（平滑轮询权重）负载均衡策略。</strong></p> <h4 id="_6-1-2-随机权重负载策略"><a href="#_6-1-2-随机权重负载策略" class="header-anchor">#</a> 6.1.2. 随机权重负载策略</h4> <p>虽然<code>LoggingAppointAdminDiscovery</code>在构造函数内默认实例化了<code>平滑轮询负载策略</code>，我们当然可以通过<code>LoggingAppointAdminDiscovery#setLoadBalanceStrategy</code>方法来进行设置具体的策略，<code>随机权重策略</code>设置方式如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
<span class="token keyword">public</span> <span class="token class-name">LoggingAppointAdminDiscovery</span> <span class="token function">loggingConfigAdminDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 初始化Logging Admin地址列表</span>
  <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> adminAddressArray <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;127.0.0.1:8080,127.0.0.1:9090&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token class-name">LoggingAppointAdminDiscovery</span> appointAdminDiscovery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoggingAppointAdminDiscovery</span><span class="token punctuation">(</span>adminAddressArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 实例化随机权重策略</span>
  <span class="token class-name">RandomWeightedStrategy</span> randomWeightedStrategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomWeightedStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置负载均衡策略</span>
  appointAdminDiscovery<span class="token punctuation">.</span><span class="token function">setLoadBalanceStrategy</span><span class="token punctuation">(</span>randomWeightedStrategy<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> appointAdminDiscovery<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>RandomWeightedStrategy</strong>（随机权重负载策略）是随机分配选择指定的<code>Logging Admin</code>地址，在上面示例中，随机权重的结果可能为：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>随机权重获取到的 Logging Admin 地址：
127.0.0.1:8080
127.0.0.1:8080
127.0.0.1:9090
127.0.0.1:8080
127.0.0.1:9090
127.0.0.1:9090
127.0.0.1:9090
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="_6-1-3-平滑轮询权重负载策略"><a href="#_6-1-3-平滑轮询权重负载策略" class="header-anchor">#</a> 6.1.3. 平滑轮询权重负载策略</h4> <p><strong>SmoothWeightedRoundRobinStrategy</strong>（平滑轮询权重负载策略）是平滑分配指定的<code>Logging Admin</code>地址，在上面示例中，平滑轮询权重的结果为：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>平滑轮询权重获取到的 Logging Admin 地址：
127.0.0.1:8080
127.0.0.1:9090
127.0.0.1:8080
127.0.0.1:9090
127.0.0.1:8080
127.0.0.1:9090
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_6-2-服务注册中心发现admin"><a href="#_6-2-服务注册中心发现admin" class="header-anchor">#</a> 6.2. 服务注册中心发现Admin</h3> <p>在<code>SpringCloud MicroService</code>部署方式下使用时，可以将<code>Logging Admin</code>作为一个单独的服务进行注册到<code>Service Registry Center</code>（服务注册中心，如：<code>Eureka</code>、<code>Zookeeper</code>、<code>Consul</code>、<code>Nacos Discovery</code>等），这样在<code>Logging Client</code>通过服务注册的发现接口即可完成<code>Logging Admin</code>的发现，获取地址后进行<code>上报请求日志</code>。</p> <p><code>Logging Client</code>内部提供了集成<code>服务注册中心</code>的服务发现实现<code>LoggingRegistryCenterAdminDiscovery</code>，通过配置实例化该类并放入<code>Spring IOC</code>即可完成自动从<code>服务注册中心</code>内获取<code>Logging Admin</code>信息。</p> <p><code>ApiBoot</code>配置使用<strong>LoggingRegistryCenterAdminDiscovery</strong>实践示例，详见源码，<a href="https://gitee.com/minbox-projects/api-boot/blob/master/api-boot-project/api-boot-autoconfigure/src/main/java/org/minbox/framework/api/boot/autoconfigure/logging/ApiBootLoggingAdminDiscoveryAutoConfiguration.java" target="_blank"><strong>ApiBootLoggingAdminDiscoveryAutoConfiguration</strong></a>。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
* ApiBoot Logging Admin Registry Center Discovery
* @param loadBalancerClient LoadBalance Client
* @return LoggingRegistryCenterAdminDiscovery
*/</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
<span class="token keyword">public</span> <span class="token class-name">LoggingRegistryCenterAdminDiscovery</span> <span class="token function">loggingRegistryCenterAdminDiscovery</span><span class="token punctuation">(</span><span class="token class-name">LoadBalancerClient</span> loadBalancerClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">LoggingRegistryCenterAdminDiscovery</span> registryCenterAdminDiscovery <span class="token operator">=</span>
    <span class="token keyword">new</span> <span class="token class-name">LoggingRegistryCenterAdminDiscovery</span><span class="token punctuation">(</span>apiBootLoggingProperties<span class="token punctuation">.</span><span class="token function">getDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServiceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> loadBalancerClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> registryCenterAdminDiscovery<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>LoadBalancerClient</strong>是<code>SpringCloud</code>负载均衡客户端对象，通过<code>SpringCloud</code>依赖的自动配置并且放入<code>Spring IOC</code>，注入该对象后即可负载均衡的发现一个可用的指定<code>serviceID</code>的服务对象<code>ServiceInstance</code>。</p> <h2 id="_7-延迟上报日志"><a href="#_7-延迟上报日志" class="header-anchor">#</a> 7. 延迟上报日志</h2> <p><code>Logging Client</code>默认采用了<code>just</code>（直接上报）的方式来上报采集到的<code>请求日志</code>，每产生一条请求日志都会实时上报到<code>Logging Admin</code>，而有些时候需求往往变化比较大，比如：降低<code>Logging Admin</code>压力，这时可能每次上报<strong>20条</strong><code>请求日志</code>到<code>Logging Admin</code>。</p> <p><strong>针对这种业务情况，<code>Logging Client</code>提供了定时上报方式。</strong></p> <h3 id="_7-1-配置上报方式"><a href="#_7-1-配置上报方式" class="header-anchor">#</a> 7.1. 配置上报方式</h3> <p><code>上报方式</code>通过<code>LoggingFactoryBean#setReportAway</code>方法来修改默认值，参数为<code>org.minbox.framework.logging.core.ReportAway</code>枚举，修改如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 设置上报方式为：timing</span>
factoryBean<span class="token punctuation">.</span><span class="token function">setReportAway</span><span class="token punctuation">(</span><span class="token class-name">ReportAway</span><span class="token punctuation">.</span>timing<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_7-2-设置单次上报的日志数量"><a href="#_7-2-设置单次上报的日志数量" class="header-anchor">#</a> 7.2. 设置单次上报的日志数量</h3> <p>单次上报请求日志数量默认值为：<code>10</code>。</p> <p>通过<code>LoggingFactoryBean#setNumberOfRequestLog</code>方法来修改默认值，如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 设置每次上报的请求日志数量</span>
factoryBean<span class="token punctuation">.</span><span class="token function">setNumberOfRequestLog</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_7-3-设置上报日志间隔时间"><a href="#_7-3-设置上报日志间隔时间" class="header-anchor">#</a> 7.3. 设置上报日志间隔时间</h3> <p>上报日志默认间隔时间为：<code>5秒</code>。</p> <p>通过<code>LoggingFactoryBean#setReportIntervalSecond</code>方法来修改默认值，如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 设备上报间隔时间，单位：秒</span>
factoryBean<span class="token punctuation">.</span><span class="token function">setReportIntervalSecond</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="_8-自定义traceid生成规则"><a href="#_8-自定义traceid生成规则" class="header-anchor">#</a> 8. 自定义TraceID生成规则</h2> <p><code>Logging Client</code>默认使用<code>UUID</code>生成的字符串作为<code>TraceId</code>（链路编号），通过<code>LoggingFactoryBean#setTraceGenerator</code>方法来修改默认的生成规则，自定义策略需要实现<code>LoggingTraceGenerator</code>接口，如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 自定义链路编号（TraceID）{@link LoggingTraceGenerator}
 *
 * @author 恒宇少年
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerTraceIdGenerator</span> <span class="token keyword">implements</span> <span class="token class-name">LoggingTraceGenerator</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createTraceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MinBoxLoggingException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>设置使用自定义的策略如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 创建自定义策略对象</span>
<span class="token class-name">CustomerTraceIdGenerator</span> customerTraceIdGenerator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomerTraceIdGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置使用自定义生成TraceID的策略</span>
factoryBean<span class="token punctuation">.</span><span class="token function">setTraceGenerator</span><span class="token punctuation">(</span>customerTraceIdGenerator<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="_9-自定义spanid生成规则"><a href="#_9-自定义spanid生成规则" class="header-anchor">#</a> 9. 自定义SpanID生成规则</h2> <p><code>Logging Client</code>默认使用<code>UUID</code>生成的字符串作为<code>SpanId</code>（单元编号），通过<code>LoggingFactoryBean#setSpanGenerator</code>方法来修改默认的生成规则，自定义策略需要实现<code>LoggingSpanGenerator</code>接口，如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 自定义单元编号（SpanID）{@link LoggingSpanGenerator}
 *
 * @author 恒宇少年
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerSpanIdGenerator</span> <span class="token keyword">implements</span> <span class="token class-name">LoggingSpanGenerator</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createSpanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MinBoxLoggingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> currentTime <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%s-%s&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>设置使用自定义策略如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 创建自定义策略对象</span>
<span class="token class-name">CustomerSpanIdGenerator</span> customerSpanIdGenerator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomerSpanIdGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置使用自定义生成SpanID的策略</span>
factoryBean<span class="token punctuation">.</span><span class="token function">setSpanGenerator</span><span class="token punctuation">(</span>customerSpanIdGenerator<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="_10-排除部分路径不进行上报日志"><a href="#_10-排除部分路径不进行上报日志" class="header-anchor">#</a> 10. 排除部分路径不进行上报日志</h2> <p><code>Logging Client</code>内默认排除了<code>/error</code>路径不进行上报日志，如果业务服务存在一些访问比较频繁的接口，而且接口并不涉及业务请求，那么建议将这些请求进行排除，比如：集成<code>SpringBootAdmin</code>后会频繁访问<code>/actuator/health</code>来检查服务的健康程度。</p> <p>通过<code>LoggingFactoryBean#setIgnorePaths</code>方法进行<strong>追加</strong><code>排除路径</code>，这里注意是追加而不是替换，所以<code>/error</code>始终是在排除的列表内，配置排除路径如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 需要排除的路径列表</span>
<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ignorePaths <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
  <span class="token string">&quot;/actuator/health&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;/index&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;/test&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 设置排除的路径列表</span>
factoryBean<span class="token punctuation">.</span><span class="token function">setIgnorePaths</span><span class="token punctuation">(</span>ignorePaths<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="_11-安全上报日志"><a href="#_11-安全上报日志" class="header-anchor">#</a> 11. 安全上报日志</h2> <p>分布式的日志采集与日志存储定然会存在安全性问题，那么在<code>Logging Admin</code>服务端已经解决了这个问题，<code>Logging Admin</code>通过集成<code>Spring Security</code>配置用户名、密码来完成<code>Basic Auth</code>认证。</p> <p>在<code>Logging Client</code>发起上报请求时，会提取<code>Logging Admin</code>路径内的<code>Basic Auth</code>认证信息，通过<code>header</code>形式进行传递认证信息。</p> <h3 id="_11-1-指定admin地址方式配置"><a href="#_11-1-指定admin地址方式配置" class="header-anchor">#</a> 11.1. 指定Admin地址方式配置</h3> <p>如果采用的是<code>LoggingAppointAdminDiscovery</code>方式配置<code>Logging Admin</code>服务地址发现，那么在构造函数初始化<code>Logging Admin</code>地址时，需要携带<code>Basic Auth</code>的用户名、密码信息，如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
<span class="token keyword">public</span> <span class="token class-name">LoggingAppointAdminDiscovery</span> <span class="token function">loggingConfigAdminDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 初始化Logging Admin地址列表</span>
  <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> adminAddressArray <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;user:123@127.0.0.1:8080,user:123@127.0.0.1:9090&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token class-name">LoggingAppointAdminDiscovery</span> appointAdminDiscovery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoggingAppointAdminDiscovery</span><span class="token punctuation">(</span>adminAddressArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> appointAdminDiscovery<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在上面示例中可以看到<code>Basic Auth</code>是通过<code>username:password@IP:Port</code>格式来进行配置，其中<code>user</code>为用户名，而<code>123</code>则是该用户的密码。</p> <h3 id="_11-2-服务注册中心配置"><a href="#_11-2-服务注册中心配置" class="header-anchor">#</a> 11.2. 服务注册中心配置</h3> <p>如果采用<code>LoggingRegistryCenterAdminDiscovery</code>方式配置<code>Logging Admin</code>服务地址发现，配置如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
* ApiBoot Logging Admin Registry Center Discovery
* setting basic auth username if not empty {@link LoggingRegistryCenterAdminDiscovery#setUsername(String)}
* setting basic auth password if not empty {@link LoggingRegistryCenterAdminDiscovery#setPassword(String)}
*
* @param loadBalancerClient LoadBalance Client
* @return LoggingRegistryCenterAdminDiscovery
*/</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
<span class="token keyword">public</span> <span class="token class-name">LoggingRegistryCenterAdminDiscovery</span> <span class="token function">loggingRegistryCenterAdminDiscovery</span><span class="token punctuation">(</span><span class="token class-name">LoadBalancerClient</span> loadBalancerClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">LoggingRegistryCenterAdminDiscovery</span> registryCenterAdminDiscovery <span class="token operator">=</span>
    <span class="token keyword">new</span> <span class="token class-name">LoggingRegistryCenterAdminDiscovery</span><span class="token punctuation">(</span>apiBootLoggingProperties<span class="token punctuation">.</span><span class="token function">getDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServiceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> loadBalancerClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 用户名</span>
  <span class="token class-name">String</span> basicAuthUserName <span class="token operator">=</span> apiBootLoggingProperties<span class="token punctuation">.</span><span class="token function">getDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>basicAuthUserName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    registryCenterAdminDiscovery<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>basicAuthUserName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 密码</span>
  <span class="token class-name">String</span> basicAuthPassword <span class="token operator">=</span> apiBootLoggingProperties<span class="token punctuation">.</span><span class="token function">getDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ObjectUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>basicAuthPassword<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    registryCenterAdminDiscovery<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>basicAuthPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> registryCenterAdminDiscovery<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>上面示例所示，根据<code>LoggingRegistryCenterAdminDiscovery#setUsername</code>方法来设置用户名，根据<code>LoggingRegistryCenterAdminDiscovery#setPassword</code>方法来设置密码。</p> <h2 id="_12-控制台显示上报日志"><a href="#_12-控制台显示上报日志" class="header-anchor">#</a> 12. 控制台显示上报日志</h2> <p><code>Logging Client</code>默认不会在控制台<strong>打印</strong>即将要上报的<code>请求日志</code>信息，可以通过<code>LoggingFactiory#setShowConsoleLog</code>方法进行设置，如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 设置在控制台输出上报的日志</span>
factoryBean<span class="token punctuation">.</span><span class="token function">setShowConsoleLog</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="_13-格式化控制台显示上报日志"><a href="#_13-格式化控制台显示上报日志" class="header-anchor">#</a> 13. 格式化控制台显示上报日志</h2> <p><code>Logging Client</code>在控制台打印上报的请求日志时，默认不进行格式化<code>json</code>字符串，根据<code>LoggingFactoryBean#setFormatConsoleLog</code>方法来进行设置，如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 设置格式化输出上报的日志</span>
factoryBean<span class="token punctuation">.</span><span class="token function">setFormatConsoleLog</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="_14-自定义日志上报通知"><a href="#_14-自定义日志上报通知" class="header-anchor">#</a> 14. 自定义日志上报通知</h2> <p><code>Logging Client</code>提供日志上报通知功能，只需要实现<code>LoggingNotice</code>接口即可获取每次上报的<code>请求日志详细对象</code>，进行日志的自定义处理，如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 自定义日志通知
 * @author 恒宇少年
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerLoggingNotice</span> <span class="token keyword">implements</span> <span class="token class-name">LoggingNotice</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 通知方法
     * 处理自定义的业务逻辑
     * @param minBoxLog
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notice</span><span class="token punctuation">(</span><span class="token class-name">MinBoxLog</span> minBoxLog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>minBoxLog<span class="token punctuation">.</span><span class="token function">getTraceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 自定义业务处理...</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 通知执行优先级
     * {@link #getOrder()}方法返回值值越小优先级越高
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="_14-1-内置的日志通知"><a href="#_14-1-内置的日志通知" class="header-anchor">#</a> 14.1. 内置的日志通知</h3> <p><code>Logging Client</code>内部提供了日志通知的具体实现，分别是：<code>LoggingLocalNotice</code>，<code>LoggingAdminNotice</code>。</p> <table><thead><tr><th>日志通知实现类</th> <th>功能作用</th></tr></thead> <tbody><tr><td><strong>LoggingLocalNotice</strong></td> <td><code>LoggingLocalNotice</code>日志通知用于在<code>控制台显示、格式化</code>日志对象详细信息，优先级为<code>Integer.MIN_VALUE</code>，源码详见<code>org.minbox.framework.logging.client.notice.support.LoggingLocalNotice</code>。</td></tr> <tr><td><strong>LoggingAdminNotice</strong></td> <td><code>LoggingAdminNotice</code>日志通知用于<code>上报日志</code>信息到<code>Logging Admin</code>，优先级为<code>Integer.MIN_VALUE + 1</code>，源码详见：<code>org.minbox.framework.logging.client.notice.support.LoggingAdminNotice</code>。</td></tr></tbody></table> <h3 id="_14-2-自定义多个日志上报通知"><a href="#_14-2-自定义多个日志上报通知" class="header-anchor">#</a> 14.2. 自定义多个日志上报通知</h3> <p><code>Logging Client</code>内部通过<code>ApplicationContext</code>从<code>Spring IOC</code>内获取指定<code>LoggingNotice</code>类型的实例列表，正因为这样也就支持了<code>多日志通知</code>的方式。</p> <div class="custom-block tip"><p class="custom-block-title">注意事项</p> <p>日志通知实现类的优先级值建议不要重复。</p></div> <h2 id="_15-全局日志"><a href="#_15-全局日志" class="header-anchor">#</a> 15. 全局日志</h2> <p>全局日志（GlobalLogging）是可以采集业务代码内的日志信息，将一个请求链路下所采集到的日志通过上报到<code>Logging Admin</code>进行存储。
在一个请求中，全局日志可能会存在多个，而在请求日志结束时需要一并将采集到的全局日志列表进行上报，这时就需要一个临时保存的机制，在<code>minbox-logging-client</code>
提供了一个<code>GlobalLogging</code>接口，该接口主要是用来定义全局日志的采集方法，按照日志的等级划分。</p> <p><code>GlobalLogging</code>接口提供的方法：</p> <table><thead><tr><th>方法</th> <th>备注</th></tr></thead> <tbody><tr><td>debug(String msg);</td> <td>采集debug等级的日志</td></tr> <tr><td>debug(String format, Object... arguments);</td> <td>采集debug等级的日志，支持参数格式化占位符</td></tr> <tr><td>info(String msg);</td> <td>采集info等级的日志</td></tr> <tr><td>info(String format, Object... arguments);</td> <td>采集info等级的日志，支持参数格式化占位符</td></tr> <tr><td>error(String msg);</td> <td>采集error等级的日志</td></tr> <tr><td>error(String msg, Throwable throwable);</td> <td>采集error等级的日志，支持采集Exception堆栈信息</td></tr> <tr><td>error(String format, Object... arguments);</td> <td>采集error等级的日志，支持参数格式化占位符</td></tr></tbody></table> <div class="custom-block tip"><p class="custom-block-title">注意事项</p> <p>日志等级是对不同的日志划分的方式，具体使用什么样子的等级来采集日志要根据自己的业务而定。</p></div> <h3 id="_15-1-日志占位符"><a href="#_15-1-日志占位符" class="header-anchor">#</a> 15.1 日志占位符</h3> <p>占位符的方式是仿照<code>logback</code>的形式来提供的功能，我们在记录日志时往往会在日志内中加入一些逻辑性判断的值或者结果，这是占位符就非常好用了，占位符使用<code>{}</code>来代替指定索引的参数，第一个<code>{}</code>对应第一个参数，如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
  * 全局日志接口
  * {@link GlobalLogging}
  *
  * @see org.minbox.framework.logging.client.global.support.GlobalLoggingMemoryStorage
  */</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">GlobalLogging</span> globalLogging<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">printLogs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 格式化后输出内容：请求地址：/index，用户名：恒宇少年</span>
  globalLogging<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;请求地址：{}，用户名：{}&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/index&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;恒宇少年&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>注意事项：</strong></p> <ul><li><code>占位符数量</code>：占位符虽然没有做数量限制，但是不宜过多。</li> <li><code>占位符参数类型</code>：占位符的接收参数为<code>java.lang.Object</code>类型，所以我们可以将任意类型的值进行打印输出。</li></ul> <h3 id="_15-2-内存方式存储"><a href="#_15-2-内存方式存储" class="header-anchor">#</a> 15.2 内存方式存储</h3> <p><code>GlobalLogging</code>是一个接口的方式进行定义，而当我们真正使用这个接口时需要实例化它的某一个具体的实现类才可以，为了方便使用，不依赖第三方存储介质，因此提供了一个名为<code>GlobalLoggingMemoryStorage</code>的内存方式存储实现类。</p> <p><code>GlobalLoggingMemoryStorage</code>从命名上我们可以了解到它内部使用内存方式进行临时存储一个请求内所有的<code>GlobalLog（全局日志）</code>，而在多线程的场景下为了各个线程之间的数据安全，采用了<code>ThreadLocal</code>来进行存储，保证每一个请求所创建的线程之间保存的全局日志相互不影响，详见：<a href="https://gitee.com/minbox-projects/minbox-logging/blob/master/minbox-logging-client/src/main/java/org/minbox/framework/logging/client/global/GlobalLoggingThreadLocal.java" target="_blank" rel="noopener noreferrer"><strong>GlobalLoggingThreadLocal</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>通过以下方式来使用<code>GlobalLoggingMemoryStorage</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">GlobalLogging</span> <span class="token function">globalLogging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GlobalLoggingMemoryStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">小提示</p> <p>这种方式可以将方法返回的对象自动加入到<code>Spring IOC</code>容器内，使用时直接注入<code>GlobalLogging</code>接口即可。</p></div> <h3 id="_15-3-采集异常堆栈信息"><a href="#_15-3-采集异常堆栈信息" class="header-anchor">#</a> 15.3 采集异常堆栈信息</h3> <p>在<code>GlobalLogging</code>接口定义中，提供了可以采集异常堆栈详细信息的<code>error</code>方法，我们只需要将<code>Throwable</code>子类的异常实例作为参数传递给该方法，就会自动采集到该异常的详细<code>Stack</code>堆栈信息，方便我们进行检查代码运行期间遇到的问题，让我们可以尽快的做出代码调整。</p> <p>使用如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 采集error日志，将Exception对象实例e作为参数传递</span>
  globalLogging<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>在上面代码中，由于被除数不允许为<code>0</code>，所以这段代码在运行期间会出现<code>java.lang.ArithmeticException</code>异常，通过<code>GlobalLogging#error</code>方法可以将该异常的详细堆栈信息采集成为字符串并且可以上传到<code>Logging Admin</code>。</p> <p>堆栈信息的采集使用<code>minbox-framework</code>核心依赖内的工具类，详见：<a href="https://gitee.com/minbox-projects/minbox-framework/blob/master/minbox-core/src/main/java/org/minbox/framework/util/StackTraceUtil.java" target="_blank" rel="noopener noreferrer"><strong>StackTraceUtil</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">12/23/2019, 2:25:51 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/logging/concept.html" class="prev">I. 概念</a></span> <span class="next"><a href="/logging/config-admin.html">III. 配置服务端</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3abc0832.js" defer></script><script src="/assets/js/2.7b9f2484.js" defer></script><script src="/assets/js/9.e3938554.js" defer></script>
  </body>
</html>
